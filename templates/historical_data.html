{% extends 'base.html' %}
{% import 'macros.html' as macros %}
{% import '_historical_data.html' as components %}

{% block content %}
    {{ macros.header() }}

    <main class="container py-4">
        <h1 class="h3 fw-bold">Historical data</h1>

        <p>
            Mangolorians currently provides historical data for order books, trades and funding rates. Order book
            data is presented as deltas or incremental updates: see <a href="https://github.com/waterquarks/mangolorians/blob/7d957bd195b759e8300d799e42d45440a1a71c17/crunch/slippage.py#L4-L68" class="text-warning text-decoration-none" target="_blank">here</a>
            to learn how to reconstruct the order book of any pair at any point in time for which there is data.
        </p>

        <p>
            Below are presented previews for every category of data available. The latest 9 entries are shown for
            each. Select a pair for which you'd like to download historical data. Then click "Download
            as CSV" in any preview to pull all available entries by the specified parameters.
        </p>


{#        <div class="d-flex align-items-center">#}
            {{ market_selector(market, markets) }}

{#            <input type="date" class="form-control w-auto ms-3 py-2" style="background-color: #141026" min="2022-03-15" max="2022-03-15" value="2022-03-15">#}
{#        </div>#}

        <br>

        {#
        Right now the only preview that takes a non-neglible amount of time to load is that of the order book deltas.
        This is because its entries already amount to a few million after after a couple of dates of scraping and
        the absense of indexes which the database could use to quickly fetch the latest 9 entries. Should add this.
        #}
        <div hx-trigger="load" hx-get="/historical_data/{{ market }}/order_book_deltas">
            <div class="card" style="border-radius: 5px">
                <div class="card-header py-3" style="border-color: #2A2440;">
                    <h2 class="h6 fw-bold mb-1">Order book deltas</h2>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border"></div>
                    </div>
                </div>
            </div>
        </div>

        <br>

        <div hx-trigger="load" hx-get="/historical_data/{{ market }}/trades">
            <div class="card" style="border-radius: 5px">
                <div class="card-header py-3" style="border-color: #2A2440;">
                    <h2 class="h6 fw-bold mb-1">Trades</h2>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border"></div>
                    </div>
                </div>
            </div>
        </div>

        <br>

        <div hx-trigger="load" hx-get="/historical_data/{{ market }}/funding_rates">
            <div class="card" style="border-radius: 5px">
                <div class="card-header py-3" style="border-color: #2A2440;">
                    <h2 class="h6 fw-bold mb-1">Funding rates</h2>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    {{ macros.footer() }}
{% endblock %}

{% macro market_selector(market, markets) %}
    <div class="dropdown p-0 m-0" id="selector">
        <button class="btn btn-dark dropdown-toggle py-2 px-4 d-flex align-items-center fw-bold"
                type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                style="background-color: #141026; border-color: #878787;">
            {% set underlying = market.split('-')[0] %}

            {% set filename = 'images/' + underlying + '.svg' %}

            <img class="me-3" width="24px" height="24px"
                 src="{{ url_for('static', filename=filename) }}"/>

            {{ market }}
        </button>

        <ul class="dropdown-menu" style="background-color: #2A2440">
            {% for market in markets %}
                <li>
                    <a class="dropdown-item py-2 px-4 fw-bold" href="/historical_data/{{ market }}">
                        {% set underlying = market.split('-')[0] %}

                        {% set filename = 'images/' + underlying + '.svg' %}

                        <img class="me-3" width="24px" height="24px"
                             src="{{ url_for('static', filename=filename) }}"/>
                        {{ market }}
                    </a>
                </li>
            {% endfor %}
        </ul>
    </div>
{% endmacro %}