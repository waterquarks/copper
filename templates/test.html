{% extends './base.html' %}
{% import '_base.html' as macros %}

{% block title %}
    | {{ accounts }}
{% endblock %}

{% block content %}
    {{ macros.header() }}

    <div class="container py-4">
        <h1 class="h3 fw-bold mb-3">Market maker analytics</h1>

        <p>Below are presented a set of order book analytics subsetted by account(s). Enter one or more public keys separated by a comma and click on "Submit" to fetch the data. Times are in UTC.</p>

        <p>The underlying code can be seen at the <a href="https://github.com/waterquarks/mangolorians/blob/8667d70f2145432dc125b9a33dcb0fe70a8040da/scrapers/reconstruct_l3_order_book.py" class="text-warning text-decoration-none" target="_blank">GitHub repo</a>.</p>

        <div class="dropdown p-0 m-0" id="selector">
            <button class="btn btn-dark dropdown-toggle py-2 px-4 d-flex align-items-center fw-bold"
                    type="button"
                    data-bs-toggle="dropdown" aria-expanded="false"
                    style="background-color: #141026; border-color: #878787;"
            >
                {% set asset = instrument | regex_replace('(-|/).*', '') %}

                {% set filename = 'images/' + asset + '.svg' %}

                <img class="me-3" width="24px" eight="24px"  src="{{ url_for('static', filename=filename) }}"/>

                {{ instrument }}
            </button>

            <ul class="dropdown-menu overflow-auto" style="background-color: #2A2440">
                {% for instrument in perpetuals %}
                    <li>
                        <a class="dropdown-item py-2 px-4 fw-bold" href="/market_maker_analytics?instrument={{ instrument }}&accounts={{ accounts }}">
                            {% set asset = instrument | regex_replace('(-|/).*', '') %}

                            {% set filename = 'images/' + asset + '.svg' %}

                            <img class="me-3" width="24px" height="24px"  src="{{ url_for('static', filename=filename) }}"/>
                            {{ instrument }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <form action="/market_maker_analytics" method="get" class="my-3">
            <input type="hidden" name="instrument" value="{{ instrument }}">

            <div>
                <label for="account" class="form-label fw-bold fs-6">Public keys</label>
                <input type="text" class="form-control" name="accounts" id="accounts" value="{{ accounts }}">
            </div>

            <div class="d-block d-lg-flex flex-wrap">
                <div class="my-2 mb-lg-0 me-lg-2 flex-grow-1">
                    <label for="target_liquidity" class="form-label fw-bold fs-6">Target liquidity</label>
                    <input type="number" class="form-control" name="target_liquidity" id="target_liquidity"  value="{{ target_liquidity or 1000 }}">
                </div>

                <div class="my-2 mb-lg-0 me-lg-2 flex-grow-1">
                    <label for="target_spread" class="form-label fw-bold fs-6">Target spread (%)</label>
                    <input type="number" class="form-control" name="target_spread" id="target_spread"  step="0.01" value="{{ target_spread or 0.15 }}">
                </div>

                <div class="my-2 mb-lg-0 me-lg-2 flex-grow-1">
                    <label for="from" class="form-label fw-bold fs-6">From</label>
                    <input class="form-control" type="datetime-local" name="from" id="from" min="2022-04-12T00:00" max="{{ max }}" value="{{ from_ }}">
                </div>

                <div class="my-2 mb-lg-0 flex-grow-1">
                    <label for="to" class="form-label fw-bold fs-6">To</label>
                    <input class="form-control" type="datetime-local" name="to" id="to" min="2022-04-12T00:00" max="{{ max }}" value="{{ to }}">
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary w-100">Submit</button>
            </div>
        </form>

        <div hx-trigger="load" hx-get="/market_maker_analytics/content?accounts={{ accounts }}&instrument={{ instrument }}&target_liquidity={{ target_liquidity }}&target_spread={{ target_spread }}&from={{ from_ }}&to={{ to }}">
            <div class="d-flex justify-content-center align-items-center py-4" id="loader">
                <div class="spinner-border text-secondary" role="status">
                </div>
            </div>
        </div>
    </div>

    {{ macros.footer() }}
{% endblock %}
